name: Update Statistics Dashboard

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    environment: github-pages
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements-dashboard.txt

      - name: Generate statistics on database server
        env:
          SSH_KEY: ${{ secrets.DB_SERVER_SSH_KEY }}
          DB_HOST: ${{ secrets.DB_SERVER_IP }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $DB_HOST >> ~/.ssh/known_hosts

          # Pull latest code and clean up old containers
          ssh -o StrictHostKeyChecking=no root@$DB_HOST "
            cd /opt/soulseek-research/repo
            git pull origin main
            docker rm -f stats-gen 2>/dev/null || true
            rm -rf /tmp/docs/*
          "

          # Start stats generation in detached mode
          ssh -o StrictHostKeyChecking=no root@$DB_HOST "
            docker run -d \
              --name stats-gen \
              --network=host \
              -v /opt/archives:/archives \
              -v /tmp/docs:/docs \
              -e DATABASE_URL='postgresql://soulseek:${DB_PASSWORD}@localhost:5432/soulseek' \
              -e ARCHIVE_PATH=/archives \
              soulseek-research:latest \
              uv run python /app/scripts/generate_stats.py
          "

          # Poll until container finishes (10 min timeout)
          echo "Waiting for stats generation to complete..."
          SECONDS=0
          while ssh -o StrictHostKeyChecking=no root@$DB_HOST "docker ps --filter name=stats-gen --format '{{.Names}}' | grep -q stats-gen"; do
            if [ $SECONDS -ge 600 ]; then
              echo "ERROR: Timeout after 10 minutes"
              ssh -o StrictHostKeyChecking=no root@$DB_HOST "docker logs stats-gen" || true
              exit 1
            fi
            echo "Still running... (${SECONDS}s elapsed)"
            sleep 10
          done
          echo "Container finished after ${SECONDS}s"

          # Check exit code
          EXIT_CODE=$(ssh -o StrictHostKeyChecking=no root@$DB_HOST "docker inspect stats-gen --format='{{.State.ExitCode}}'")
          echo "Container exit code: $EXIT_CODE"

          if [ "$EXIT_CODE" != "0" ]; then
            echo "ERROR: Stats generation failed!"
            ssh -o StrictHostKeyChecking=no root@$DB_HOST "docker logs stats-gen"
            exit 1
          fi

          # Download generated docs
          scp -r -o StrictHostKeyChecking=no root@$DB_HOST:/tmp/docs ./

          # Cleanup
          ssh -o StrictHostKeyChecking=no root@$DB_HOST "docker rm stats-gen"

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./docs
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
